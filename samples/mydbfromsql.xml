<?xml version="1.0" encoding="UTF-8"?>
<database>
    <name>mydb</name>
    <table>
        <database></database>
        <name>hosts</name>
        <ddl>CREATE TABLE hosts (
            ip          VARCHAR(16) PRIMARY KEY NOT NULL,
            mac         VARCHAR(18),
            hostname    VARCHAR(129),
            protocol    VARCHAR(5) DEFAULT 'ipv4',
            os_name     TEXT,
            os_family   TEXT,
            os_accuracy INTEGER,
            os_gen      TEXT,
            last_update TIMESTAMP,
            state       VARCHAR(8) DEFAULT 'down',
            mac_vendor  TEXT,
            whois       TEXT
        )</ddl>
        <columns>
            <column>
                <name>ip</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>PRIMARY KEY</type>
                        <definition>PRIMARY KEY </definition>
                    </constraint>
                    <constraint>
                        <type>NOT NULL</type>
                        <definition>NOT NULL</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>mac</name>
                <type>VARCHAR</type>
            </column>
            <column>
                <name>hostname</name>
                <type>VARCHAR</type>
            </column>
            <column>
                <name>protocol</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>DEFAULT</type>
                        <definition>DEFAULT 'ipv4'</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>os_name</name>
                <type>TEXT</type>
            </column>
            <column>
                <name>os_family</name>
                <type>TEXT</type>
            </column>
            <column>
                <name>os_accuracy</name>
                <type>INTEGER</type>
            </column>
            <column>
                <name>os_gen</name>
                <type>TEXT</type>
            </column>
            <column>
                <name>last_update</name>
                <type>TIMESTAMP</type>
            </column>
            <column>
                <name>state</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>DEFAULT</type>
                        <definition>DEFAULT 'down'</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>mac_vendor</name>
                <type>TEXT</type>
            </column>
            <column>
                <name>whois</name>
                <type>TEXT</type>
            </column>
        </columns>
        <rows>
            <row>
                <value column="0">78535594</value>
                <value column="1" null="true"/>
                <value column="2" null="true"/>
                <value column="3">ipv4</value>
                <value column="4" null="true"/>
                <value column="5" null="true"/>
                <value column="6" null="true"/>
                <value column="7" null="true"/>
                <value column="8" null="true"/>
                <value column="9">down</value>
                <value column="10" null="true"/>
                <value column="11" null="true"/>
            </row>
            <row>
                <value column="0">89258389</value>
                <value column="1" null="true"/>
                <value column="2" null="true"/>
                <value column="3">ipv4</value>
                <value column="4" null="true"/>
                <value column="5" null="true"/>
                <value column="6" null="true"/>
                <value column="7" null="true"/>
                <value column="8" null="true"/>
                <value column="9">down</value>
                <value column="10" null="true"/>
                <value column="11" null="true"/>
            </row>
            <row>
                <value column="0">52234982</value>
                <value column="1" null="true"/>
                <value column="2" null="true"/>
                <value column="3">ipv4</value>
                <value column="4" null="true"/>
                <value column="5" null="true"/>
                <value column="6" null="true"/>
                <value column="7" null="true"/>
                <value column="8" null="true"/>
                <value column="9">down</value>
                <value column="10" null="true"/>
                <value column="11" null="true"/>
            </row>
            <row>
                <value column="0">44900631</value>
                <value column="1" null="true"/>
                <value column="2" null="true"/>
                <value column="3">ipv4</value>
                <value column="4" null="true"/>
                <value column="5" null="true"/>
                <value column="6" null="true"/>
                <value column="7" null="true"/>
                <value column="8" null="true"/>
                <value column="9">down</value>
                <value column="10" null="true"/>
                <value column="11" null="true"/>
            </row>
            <row>
                <value column="0">77.231.15.95</value>
                <value column="1" null="true"/>
                <value column="2" null="true"/>
                <value column="3">ipv4</value>
                <value column="4" null="true"/>
                <value column="5" null="true"/>
                <value column="6" null="true"/>
                <value column="7" null="true"/>
                <value column="8" null="true"/>
                <value column="9">down</value>
                <value column="10" null="true"/>
                <value column="11" null="true"/>
            </row>
        </rows>
    </table>
    <table>
        <database></database>
        <name>ports</name>
        <ddl>CREATE TABLE ports (
            ip          VARCHAR(16) NOT NULL,
            port        INTEGER NOT NULL,
            protocol    VARCHAR(4) NOT NULL,
            name        VARCHAR(33),
            state       VARCHAR(33) DEFAULT 'closed',
            service     TEXT,
            info        TEXT,
            PRIMARY KEY (ip, port, protocol),
            CONSTRAINT fk_ports_hosts FOREIGN KEY (ip) REFERENCES hosts(ip) ON DELETE CASCADE
        )</ddl>
        <columns>
            <column>
                <name>ip</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>NOT NULL</type>
                        <definition>NOT NULL</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>port</name>
                <type>INTEGER</type>
                <constraints>
                    <constraint>
                        <type>NOT NULL</type>
                        <definition>NOT NULL</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>protocol</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>NOT NULL</type>
                        <definition>NOT NULL</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>name</name>
                <type>VARCHAR</type>
            </column>
            <column>
                <name>state</name>
                <type>VARCHAR</type>
                <constraints>
                    <constraint>
                        <type>DEFAULT</type>
                        <definition>DEFAULT 'closed'</definition>
                    </constraint>
                </constraints>
            </column>
            <column>
                <name>service</name>
                <type>TEXT</type>
            </column>
            <column>
                <name>info</name>
                <type>TEXT</type>
            </column>
        </columns>
        <constraints>
            <constraint>
                <type>PRIMARY KEY</type>
                <definition>PRIMARY KEY (ip, port, protocol)</definition>
            </constraint>
            <constraint>
                <type>FOREIGN KEY</type>
                <definition>FOREIGN KEY (ip) REFERENCES hosts(ip) ON DELETE CASCADE
                </definition>
            </constraint>
        </constraints>
        <rows>
        </rows>
    </table>
    <trigger>
        <database></database>
        <name>fkd_ports_hosts_ip</name>
        <ddl>CREATE TRIGGER fkd_ports_hosts_ip
        BEFORE DELETE ON hosts
        FOR EACH ROW BEGIN
            DELETE from ports WHERE ip = OLD.ip;
        END</ddl>
        <timing>BEFORE</timing>
        <action>DELETE</action>
        <table>hosts<table>
        <code>DELETE from ports WHERE ip = OLD.ip</code>
    </trigger>
    <trigger>
        <database></database>
        <name>fki_ports_hosts_ip</name>
        <ddl><![CDATA[CREATE TRIGGER fki_ports_hosts_ip
        BEFORE INSERT ON ports
        FOR EACH ROW BEGIN
            SELECT CASE
                WHEN ((SELECT ip FROM hosts WHERE ip = NEW.ip) IS NULL)
                THEN RAISE(ABORT, 'insert on table "ports" violates foreign key constraint "fk_ports_hosts"')
            END;
        END]]></ddl>
        <timing>BEFORE</timing>
        <action>INSERT</action>
        <table>ports<table>
        <code><![CDATA[SELECT CASE
                WHEN ((SELECT ip FROM hosts WHERE ip = NEW.ip) IS NULL)
                THEN RAISE(ABORT, 'insert on table "ports" violates foreign key constraint "fk_ports_hosts"')
            END]]></code>
    </trigger>
    <trigger>
        <database></database>
        <name>fku_ports_hosts_ip</name>
        <ddl><![CDATA[CREATE TRIGGER fku_ports_hosts_ip
        BEFORE UPDATE ON ports
        FOR EACH ROW BEGIN
            SELECT CASE
                WHEN ((SELECT ip FROM hosts WHERE ip = NEW.ip) IS NULL)
                THEN RAISE(ABORT, 'update on table "ports" violates foreign key constraint "fk_ports_hosts"')
            END;
        END]]></ddl>
        <timing>BEFORE</timing>
        <action>UPDATE</action>
        <table>ports<table>
        <code><![CDATA[SELECT CASE
                WHEN ((SELECT ip FROM hosts WHERE ip = NEW.ip) IS NULL)
                THEN RAISE(ABORT, 'update on table "ports" violates foreign key constraint "fk_ports_hosts"')
            END]]></code>
    </trigger>
</database>
